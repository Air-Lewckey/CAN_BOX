# STM32F407 + MCP2515 CANé€šä¿¡ç³»ç»Ÿ

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯åŸºäºSTM32F407å¾®æ§åˆ¶å™¨å’ŒMCP2515 CANæ§åˆ¶å™¨çš„åŒCANèŠ‚ç‚¹é€šä¿¡ç³»ç»Ÿã€‚ç³»ç»Ÿé‡‡ç”¨FreeRTOSå®æ—¶æ“ä½œç³»ç»Ÿï¼Œå®ç°äº†å®Œæ•´çš„CANé€šä¿¡åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ¶ˆæ¯å‘é€ã€æ¥æ”¶ã€å¤„ç†å’ŒçŠ¶æ€ç›‘æ§ã€‚

### ä¸»è¦ç‰¹æ€§

- **åŒCANèŠ‚ç‚¹æ¶æ„**ï¼šæ”¯æŒSTM32F407å†…ç½®CANæ§åˆ¶å™¨å’ŒMCP2515å¤–éƒ¨CANæ§åˆ¶å™¨
- **å¤šä»»åŠ¡è®¾è®¡**ï¼šåŸºäºFreeRTOSçš„å¤šä»»åŠ¡å¹¶å‘å¤„ç†
- **å®Œæ•´çš„CANåè®®æ ˆ**ï¼šä»åº•å±‚é©±åŠ¨åˆ°åº”ç”¨å±‚çš„å®Œæ•´å®ç°
- **æ™ºèƒ½è¯Šæ–­åŠŸèƒ½**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤å¸¸è§CANé€šä¿¡é—®é¢˜
- **ä¸°å¯Œçš„æ¶ˆæ¯ç±»å‹**ï¼šæ”¯æŒå¿ƒè·³ã€æ•°æ®ã€çŠ¶æ€ã€æ§åˆ¶ç­‰å¤šç§æ¶ˆæ¯
- **å®æ—¶è°ƒè¯•è¾“å‡º**ï¼šé€šè¿‡USART2ä¸²å£æä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

## ç³»ç»Ÿæ¶æ„

### ç¡¬ä»¶æ¶æ„

```
STM32F407å¼€å‘æ¿
â”œâ”€â”€ å†…ç½®CANæ§åˆ¶å™¨ (CAN1)
â”‚   â””â”€â”€ è¿æ¥åˆ°WCMCU-230æ¨¡å—
â”œâ”€â”€ SPI1æ¥å£
â”‚   â””â”€â”€ è¿æ¥åˆ°MCP2515 CANæ§åˆ¶å™¨
â”œâ”€â”€ USART2
â”‚   â””â”€â”€ è°ƒè¯•ä¸²å£è¾“å‡º
â””â”€â”€ GPIO
    â”œâ”€â”€ MCP2515_CS (ç‰‡é€‰)
    â”œâ”€â”€ MCP2515_INT (ä¸­æ–­)
    â””â”€â”€ LEDæŒ‡ç¤ºç¯
```

### è½¯ä»¶æ¶æ„

é¡¹ç›®é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ¨¡å—ï¼š

#### 1. é©±åŠ¨å±‚ (Driver Layer)
- **mcp2515.c/h**: MCP2515 CANæ§åˆ¶å™¨åº•å±‚é©±åŠ¨
- **can.c/h**: STM32å†…ç½®CANæ§åˆ¶å™¨é©±åŠ¨
- **usart.c/h**: ä¸²å£é€šä¿¡é©±åŠ¨
- **spi.c/h**: SPIé€šä¿¡é©±åŠ¨

#### 2. åº”ç”¨å±‚ (Application Layer)
- **can_app.c/h**: MCP2515 CANåº”ç”¨å±‚å°è£…
- **can_dual_node.c/h**: åŒCANèŠ‚ç‚¹é€šä¿¡ç®¡ç†
- **main.c**: ä¸»ç¨‹åºå’Œä»»åŠ¡è°ƒåº¦

#### 3. ç³»ç»Ÿå±‚ (System Layer)
- **FreeRTOS**: å®æ—¶æ“ä½œç³»ç»Ÿ
- **HALåº“**: STM32ç¡¬ä»¶æŠ½è±¡å±‚
- **ä¸­æ–­å¤„ç†**: ç³»ç»Ÿä¸­æ–­å’Œå›è°ƒå‡½æ•°

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. MCP2515é©±åŠ¨æ¨¡å— (mcp2515.c)

#### ä¸»è¦åŠŸèƒ½
- SPIåº•å±‚é€šä¿¡
- å¯„å­˜å™¨è¯»å†™æ“ä½œ
- CANæ§åˆ¶å™¨åˆå§‹åŒ–å’Œé…ç½®
- CANæ¶ˆæ¯å‘é€å’Œæ¥æ”¶
- ä¸­æ–­å¤„ç†å’ŒçŠ¶æ€æŸ¥è¯¢
- é”™è¯¯å¤„ç†å’Œè°ƒè¯•åŠŸèƒ½

#### æ ¸å¿ƒå‡½æ•°è¯¦è§£

##### åˆå§‹åŒ–å‡½æ•°
```c
MCP2515_Result_t MCP2515_Init(MCP2515_Baudrate_t baudrate)
```
**åŠŸèƒ½**: åˆå§‹åŒ–MCP2515æ§åˆ¶å™¨
**å‚æ•°**: 
- `baudrate`: CANæ€»çº¿æ³¢ç‰¹ç‡ (125K/250K/500K/1M)
**è¿”å›å€¼**: MCP2515_OKè¡¨ç¤ºæˆåŠŸ
**å®ç°é€»è¾‘**:
1. å¤ä½MCP2515èŠ¯ç‰‡
2. è®¾ç½®é…ç½®æ¨¡å¼
3. é…ç½®æ³¢ç‰¹ç‡å‚æ•°
4. è®¾ç½®æ¥æ”¶è¿‡æ»¤å™¨
5. åˆ‡æ¢åˆ°æ­£å¸¸å·¥ä½œæ¨¡å¼

##### æ¶ˆæ¯å‘é€å‡½æ•°
```c
MCP2515_Result_t MCP2515_SendMessage(MCP2515_CANMessage_t *message)
```
**åŠŸèƒ½**: å‘é€CANæ¶ˆæ¯
**å‚æ•°**: 
- `message`: æŒ‡å‘CANæ¶ˆæ¯ç»“æ„ä½“çš„æŒ‡é’ˆ
**è¿”å›å€¼**: MCP2515_OKè¡¨ç¤ºå‘é€æˆåŠŸ
**å®ç°é€»è¾‘**:
1. æ£€æŸ¥å‘é€ç¼“å†²åŒºçŠ¶æ€
2. é€‰æ‹©å¯ç”¨çš„å‘é€ç¼“å†²åŒº
3. åŠ è½½æ¶ˆæ¯æ•°æ®åˆ°ç¼“å†²åŒº
4. å¯åŠ¨å‘é€è¯·æ±‚
5. ç­‰å¾…å‘é€å®Œæˆ

##### æ¶ˆæ¯æ¥æ”¶å‡½æ•°
```c
MCP2515_Result_t MCP2515_ReceiveMessage(MCP2515_CANMessage_t *message)
```
**åŠŸèƒ½**: æ¥æ”¶CANæ¶ˆæ¯
**å‚æ•°**: 
- `message`: ç”¨äºå­˜å‚¨æ¥æ”¶æ¶ˆæ¯çš„ç»“æ„ä½“æŒ‡é’ˆ
**è¿”å›å€¼**: MCP2515_OKè¡¨ç¤ºæ¥æ”¶æˆåŠŸ
**å®ç°é€»è¾‘**:
1. æ£€æŸ¥æ¥æ”¶ç¼“å†²åŒºçŠ¶æ€
2. è¯»å–æ¥æ”¶ç¼“å†²åŒºæ•°æ®
3. è§£ææ¶ˆæ¯å¤´å’Œæ•°æ®
4. æ¸…é™¤æ¥æ”¶æ ‡å¿—

##### è¿‡æ»¤å™¨è®¾ç½®å‡½æ•°
```c
MCP2515_Result_t MCP2515_SetFilter(uint8_t filter_num, uint32_t filter_id, uint8_t extended)
MCP2515_Result_t MCP2515_SetMask(uint8_t mask_num, uint32_t mask_value, uint8_t extended)
```
**åŠŸèƒ½**: è®¾ç½®æ¥æ”¶è¿‡æ»¤å™¨å’Œæ©ç 
**å‚æ•°**: 
- `filter_num/mask_num`: è¿‡æ»¤å™¨/æ©ç ç¼–å· (0-5)
- `filter_id/mask_value`: è¿‡æ»¤å™¨ID/æ©ç å€¼
- `extended`: æ˜¯å¦ä¸ºæ‰©å±•å¸§
**å®ç°é€»è¾‘**:
1. åˆ‡æ¢åˆ°é…ç½®æ¨¡å¼
2. å†™å…¥è¿‡æ»¤å™¨/æ©ç å¯„å­˜å™¨
3. æ¢å¤å·¥ä½œæ¨¡å¼

### 2. CANåº”ç”¨å±‚æ¨¡å— (can_app.c)

#### ä¸»è¦åŠŸèƒ½
- åŸºäºMCP2515çš„CANé€šä¿¡åº”ç”¨å±‚å°è£…
- å¤šä»»åŠ¡CANæ¶ˆæ¯å¤„ç†
- æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†
- ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
- åº”ç”¨å±‚æ¶ˆæ¯åè®®

#### æ ¸å¿ƒå‡½æ•°è¯¦è§£

##### åº”ç”¨åˆå§‹åŒ–å‡½æ•°
```c
uint8_t CAN_App_Init(void)
```
**åŠŸèƒ½**: åˆå§‹åŒ–CANåº”ç”¨å±‚
**è¿”å›å€¼**: CAN_APP_OKè¡¨ç¤ºæˆåŠŸ
**å®ç°é€»è¾‘**:
1. åˆå§‹åŒ–MCP2515ç¡¬ä»¶
2. é…ç½®æ¥æ”¶è¿‡æ»¤å™¨
3. è®¾ç½®é»˜è®¤å‚æ•°
4. åˆå§‹åŒ–ç»Ÿè®¡è®¡æ•°å™¨

##### å‘é€ä»»åŠ¡ä¸»å‡½æ•°
```c
void CAN_SendTask_Main(void *argument)
```
**åŠŸèƒ½**: CANå‘é€ä»»åŠ¡çš„ä¸»å¾ªç¯
**å®ç°é€»è¾‘**:
1. å‘¨æœŸæ€§å‘é€å¿ƒè·³æ¶ˆæ¯ (1ç§’é—´éš”)
2. å‘¨æœŸæ€§å‘é€æµ‹è¯•æ•°æ® (2ç§’é—´éš”)
3. å‘¨æœŸæ€§å‘é€çŠ¶æ€æ¶ˆæ¯ (5ç§’é—´éš”)
4. å‘¨æœŸæ€§å‘é€ä¼ æ„Ÿå™¨æ•°æ® (3ç§’é—´éš”)
5. å‘¨æœŸæ€§å‘é€æ§åˆ¶æŒ‡ä»¤ (10ç§’é—´éš”)
6. å¤„ç†æ¥è‡ªé˜Ÿåˆ—çš„å‘é€è¯·æ±‚

##### æ¥æ”¶ä»»åŠ¡ä¸»å‡½æ•°
```c
void CAN_ReceiveTask_Main(void *argument)
```
**åŠŸèƒ½**: CANæ¥æ”¶ä»»åŠ¡çš„ä¸»å¾ªç¯
**å®ç°é€»è¾‘**:
1. æ£€æŸ¥MCP2515æ¥æ”¶çŠ¶æ€
2. æ¥æ”¶å¹¶è§£æCANæ¶ˆæ¯
3. æ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œå¤„ç†
4. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
5. è¾“å‡ºè°ƒè¯•ä¿¡æ¯

##### æ¶ˆæ¯å¤„ç†å‡½æ•°
```c
static void CAN_ProcessReceivedMessage_App(MCP2515_CANMessage_t *message)
```
**åŠŸèƒ½**: å¤„ç†æ¥æ”¶åˆ°çš„CANæ¶ˆæ¯
**æ”¯æŒçš„æ¶ˆæ¯ç±»å‹**:
- **å¿ƒè·³æ¶ˆæ¯** (ID: 0x100): åŒ…å«å‘é€è®¡æ•°å™¨ä¿¡æ¯
- **æ•°æ®æ¶ˆæ¯** (ID: 0x200): åŒ…å«æµ‹è¯•æ•°æ®å’Œè®¡æ•°å™¨
- **çŠ¶æ€æ¶ˆæ¯** (ID: 0x300): åŒ…å«ç³»ç»ŸçŠ¶æ€å’Œé”™è¯¯æ ‡å¿—
- **ä¼ æ„Ÿå™¨æ¶ˆæ¯** (ID: 0x400): åŒ…å«ä¼ æ„Ÿå™¨æ•°å€¼å’Œç±»å‹
- **æ§åˆ¶æ¶ˆæ¯** (ID: 0x500): åŒ…å«æ§åˆ¶æŒ‡ä»¤å’Œå‚æ•°

##### åº”ç”¨æ¥å£å‡½æ•°
```c
uint8_t CAN_App_SendMessage(uint32_t id, uint8_t *data, uint8_t length, uint8_t extended)
uint8_t CAN_App_SendRemoteFrame(uint32_t id, uint8_t dlc, uint8_t extended)
uint8_t CAN_App_SetFilter(uint32_t filter_id, uint32_t mask, uint8_t extended)
```
**åŠŸèƒ½**: æä¾›ç»™ç”¨æˆ·çš„åº”ç”¨å±‚æ¥å£
**ç‰¹ç‚¹**: 
- å‚æ•°æ£€æŸ¥å’Œé”™è¯¯å¤„ç†
- é˜Ÿåˆ—æ–¹å¼çš„å¼‚æ­¥å‘é€
- ç»Ÿè®¡ä¿¡æ¯è‡ªåŠ¨æ›´æ–°
- è°ƒè¯•ä¿¡æ¯è¾“å‡º

### 3. åŒèŠ‚ç‚¹é€šä¿¡æ¨¡å— (can_dual_node.c)

#### ä¸»è¦åŠŸèƒ½
- STM32å†…ç½®CANæ§åˆ¶å™¨ä¸WCMCU-230æ¨¡å—é€šä¿¡
- åŒèŠ‚ç‚¹çŠ¶æ€ç›‘æ§
- æ¶ˆæ¯åè®®å®šä¹‰
- é€šä¿¡ç»Ÿè®¡å’Œè¯Šæ–­

#### æ ¸å¿ƒå‡½æ•°è¯¦è§£

##### åŒèŠ‚ç‚¹åˆå§‹åŒ–å‡½æ•°
```c
HAL_StatusTypeDef CAN_DualNode_Init(void)
```
**åŠŸèƒ½**: åˆå§‹åŒ–åŒCANèŠ‚ç‚¹é€šä¿¡
**å®ç°é€»è¾‘**:
1. é…ç½®CANè¿‡æ»¤å™¨
2. å¯åŠ¨CANæ§åˆ¶å™¨
3. æ¿€æ´»æ¥æ”¶ä¸­æ–­
4. æ¿€æ´»å‘é€å®Œæˆä¸­æ–­
5. æ¿€æ´»é”™è¯¯ä¸­æ–­
6. åˆå§‹åŒ–ç»Ÿè®¡ä¿¡æ¯

##### æ¶ˆæ¯å‘é€å‡½æ•°
```c
HAL_StatusTypeDef CAN_SendToWCMCU(uint32_t id, uint8_t* data, uint8_t len)
HAL_StatusTypeDef CAN_SendHeartbeat(void)
HAL_StatusTypeDef CAN_SendDataRequest(uint8_t req_type, uint8_t req_param)
HAL_StatusTypeDef CAN_SendDataResponse(uint8_t* data, uint8_t len)
HAL_StatusTypeDef CAN_SendStatusMessage(void)
HAL_StatusTypeDef CAN_SendControlCommand(uint16_t cmd, uint16_t param)
```
**åŠŸèƒ½**: å‘é€ä¸åŒç±»å‹çš„CANæ¶ˆæ¯
**æ¶ˆæ¯æ ¼å¼**:
- **å¿ƒè·³æ¶ˆæ¯**: é­”æ•°(2å­—èŠ‚) + è®¡æ•°å™¨(2å­—èŠ‚)
- **æ•°æ®è¯·æ±‚**: è¯·æ±‚ç±»å‹(1å­—èŠ‚) + è¯·æ±‚å‚æ•°(1å­—èŠ‚)
- **çŠ¶æ€æ¶ˆæ¯**: é­”æ•°(2å­—èŠ‚) + çŠ¶æ€(1å­—èŠ‚) + è®¡æ•°å™¨(2å­—èŠ‚) + æ—¶é—´æˆ³(1å­—èŠ‚)
- **æ§åˆ¶æŒ‡ä»¤**: é­”æ•°(2å­—èŠ‚) + å‘½ä»¤(2å­—èŠ‚)

##### æ¶ˆæ¯å¤„ç†å‡½æ•°
```c
void CAN_ProcessReceivedMessage(CAN_RxHeaderTypeDef* header, uint8_t* data)
CAN_MessageType_t CAN_GetMessageType(uint32_t id)
void CAN_ProcessHeartbeat(uint8_t* data, uint8_t len)
void CAN_ProcessDataRequest(uint8_t* data, uint8_t len)
void CAN_ProcessDataResponse(uint8_t* data, uint8_t len)
void CAN_ProcessStatusMessage(uint8_t* data, uint8_t len)
void CAN_ProcessControlCommand(uint8_t* data, uint8_t len)
```
**åŠŸèƒ½**: å¤„ç†æ¥æ”¶åˆ°çš„ä¸åŒç±»å‹æ¶ˆæ¯
**å®ç°é€»è¾‘**:
1. æ ¹æ®æ¶ˆæ¯IDç¡®å®šæ¶ˆæ¯ç±»å‹
2. éªŒè¯æ¶ˆæ¯æ ¼å¼å’Œé­”æ•°
3. è§£ææ¶ˆæ¯å†…å®¹
4. æ‰§è¡Œç›¸åº”çš„å¤„ç†é€»è¾‘
5. æ›´æ–°èŠ‚ç‚¹çŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯

## æ•°æ®ç»“æ„å®šä¹‰

### 1. CANæ¶ˆæ¯ç»“æ„ä½“
```c
typedef struct {
    uint32_t id;        // CAN ID
    uint8_t ide;        // æ ‡è¯†ç¬¦æ‰©å±•ä½ (0=æ ‡å‡†å¸§, 1=æ‰©å±•å¸§)
    uint8_t rtr;        // è¿œç¨‹ä¼ è¾“è¯·æ±‚ (0=æ•°æ®å¸§, 1=è¿œç¨‹å¸§)
    uint8_t dlc;        // æ•°æ®é•¿åº¦ä»£ç  (0-8)
    uint8_t data[8];    // æ•°æ®å­—èŠ‚
} MCP2515_CANMessage_t;
```

### 2. åº”ç”¨å±‚æ¶ˆæ¯ç»“æ„ä½“
```c
typedef struct {
    MCP2515_CANMessage_t message;  // CANæ¶ˆæ¯
    uint32_t timestamp;            // æ—¶é—´æˆ³
    uint8_t priority;              // ä¼˜å…ˆçº§
} CAN_QueueMessage_t;
```

### 3. ç»Ÿè®¡ä¿¡æ¯ç»“æ„ä½“
```c
typedef struct {
    uint8_t initialized;     // åˆå§‹åŒ–çŠ¶æ€
    uint32_t tx_count;       // å‘é€è®¡æ•°
    uint32_t rx_count;       // æ¥æ”¶è®¡æ•°
    uint32_t error_count;    // é”™è¯¯è®¡æ•°
    uint32_t last_tx_time;   // æœ€åå‘é€æ—¶é—´
    uint32_t last_rx_time;   // æœ€åæ¥æ”¶æ—¶é—´
} CAN_App_Stats_t;
```

## æ¶ˆæ¯åè®®å®šä¹‰

### æ¶ˆæ¯IDåˆ†é…
```c
#define CAN_HEARTBEAT_ID        0x100  // å¿ƒè·³æ¶ˆæ¯
#define CAN_DATA_ID             0x200  // æ•°æ®æ¶ˆæ¯
#define CAN_APP_STATUS_ID       0x300  // åº”ç”¨çŠ¶æ€æ¶ˆæ¯
#define CAN_SENSOR_ID           0x400  // ä¼ æ„Ÿå™¨æ•°æ®
#define CAN_CONTROL_ID          0x500  // æ§åˆ¶æŒ‡ä»¤
#define CAN_ERROR_ID            0x7FF  // é”™è¯¯æ¶ˆæ¯

// åŒèŠ‚ç‚¹é€šä¿¡ID
#define CAN_DATA_REQUEST_ID     0x601  // æ•°æ®è¯·æ±‚
#define CAN_DATA_RESPONSE_ID    0x602  // æ•°æ®å“åº”
#define CAN_STATUS_ID           0x603  // çŠ¶æ€æ¶ˆæ¯
```

### æ¶ˆæ¯æ ¼å¼

#### å¿ƒè·³æ¶ˆæ¯ (0x100)
| å­—èŠ‚ | æè¿° | å€¼ |
|------|------|----|
| 0-1  | é­”æ•° | 0xAA55 |
| 2-5  | å‘é€è®¡æ•°å™¨ | 32ä½è®¡æ•°å€¼ |
| 6-7  | ä¿ç•™ | 0x00 |

#### æ•°æ®æ¶ˆæ¯ (0x200)
| å­—èŠ‚ | æè¿° | å€¼ |
|------|------|----|
| 0-1  | é­”æ•° | 0x1234 |
| 2-3  | æ•°æ®è®¡æ•°å™¨ | 16ä½è®¡æ•°å€¼ |
| 4-7  | æµ‹è¯•æ•°æ® | éšæœºæ•°æ® |

#### çŠ¶æ€æ¶ˆæ¯ (0x300)
| å­—èŠ‚ | æè¿° | å€¼ |
|------|------|----|
| 0-1  | é­”æ•° | 0x5354 |
| 2    | ç³»ç»ŸçŠ¶æ€ | çŠ¶æ€ç  |
| 3    | é”™è¯¯æ ‡å¿— | 0=æ­£å¸¸, 1=é”™è¯¯ |
| 4-5  | å‘é€è®¡æ•° | 16ä½è®¡æ•°å€¼ |
| 6-7  | æ¥æ”¶è®¡æ•° | 16ä½è®¡æ•°å€¼ |

## ä»»åŠ¡è°ƒåº¦

### FreeRTOSä»»åŠ¡é…ç½®

| ä»»åŠ¡åç§° | ä¼˜å…ˆçº§ | å †æ ˆå¤§å° | åŠŸèƒ½æè¿° |
|----------|--------|----------|----------|
| defaultTask | osPriorityNormal | 128 words | ç³»ç»Ÿå¿ƒè·³ç›‘æµ‹ |
| CANSendTask | osPriorityNormal | 128 words | CANæ¶ˆæ¯å‘é€ |
| CANReceiveTask | osPriorityAboveNormal | 128 words | CANæ¶ˆæ¯æ¥æ”¶ |

### æ¶ˆæ¯é˜Ÿåˆ—é…ç½®

| é˜Ÿåˆ—åç§° | å¤§å° | å…ƒç´ ç±»å‹ | åŠŸèƒ½æè¿° |
|----------|------|----------|----------|
| myQueue01 | 16 | CAN_QueueMessage_t | CANå‘é€æ¶ˆæ¯é˜Ÿåˆ— |

## ç¼–è¯‘å’Œä½¿ç”¨

### å¼€å‘ç¯å¢ƒè¦æ±‚
- STM32CubeIDE 1.8.0æˆ–æ›´é«˜ç‰ˆæœ¬
- STM32F4xx HALåº“
- FreeRTOS
- æ­£ç‚¹åŸå­STM32F407å¼€å‘æ¿
- MCP2515 CANæ§åˆ¶å™¨æ¨¡å—

### ç¡¬ä»¶è¿æ¥

#### STM32F407ä¸MCP2515è¿æ¥
| STM32F407 | MCP2515 | åŠŸèƒ½ |
|-----------|---------|------|
| PA5 (SPI1_SCK) | SCK | SPIæ—¶é’Ÿ |
| PA6 (SPI1_MISO) | SO | SPIæ•°æ®è¾“å‡º |
| PA7 (SPI1_MOSI) | SI | SPIæ•°æ®è¾“å…¥ |
| PA4 | CS | ç‰‡é€‰ä¿¡å· |
| PA3 | INT | ä¸­æ–­ä¿¡å· |
| 3.3V | VCC | ç”µæº |
| GND | GND | åœ°çº¿ |

#### ä¸²å£è¿æ¥
| STM32F407 | USBè½¬ä¸²å£ | åŠŸèƒ½ |
|-----------|-----------|------|
| PA2 (USART2_TX) | RX | ä¸²å£å‘é€ |
| PA3 (USART2_RX) | TX | ä¸²å£æ¥æ”¶ |
| GND | GND | åœ°çº¿ |

## ğŸ”„ CANå¾ªç¯æµ‹è¯•åŠŸèƒ½

### æµ‹è¯•åŸç†
æœ¬é¡¹ç›®å®ç°äº†åŒCANèŠ‚ç‚¹å¾ªç¯é€šä¿¡æµ‹è¯•ï¼Œæµ‹è¯•æµç¨‹å¦‚ä¸‹ï¼š

```
[STM32 CAN1] --å‘é€--> [MCP2515] --è½¬å‘--> [STM32 CAN1] --æ¥æ”¶å®Œæˆ--
     â†‘                                                      |
     |                    1ç§’å‘¨æœŸ                            |
     +--------------------ä¸‹ä¸€è½®å‘é€<---------------------+
```

### ç¡¬ä»¶è¿æ¥ï¼ˆå¾ªç¯æµ‹è¯•ï¼‰
**é‡è¦**: ä½¿ç”¨æœé‚¦çº¿å°†ä¸¤è·¯CANç›´æ¥è¿æ¥

```
STM32F407 CAN1 â†â†’ MCP2515 CAN
â”œâ”€ CAN1_H (PD1) â†â†’ MCP2515 CAN_H
â””â”€ CAN1_L (PD0) â†â†’ MCP2515 CAN_L

MCP2515 SPIè¿æ¥ï¼š
â”œâ”€ CS   â†â†’ PA4
â”œâ”€ SCK  â†â†’ PA5  
â”œâ”€ MISO â†â†’ PA6
â”œâ”€ MOSI â†â†’ PA7
â””â”€ INT  â†â†’ PA3
```

### æµ‹è¯•æ¶ˆæ¯æ ¼å¼

#### å¾ªç¯æµ‹è¯•æ¶ˆæ¯ (ID: 0x123)
| å­—èŠ‚ | æè¿° | å€¼ |
|------|------|----||
| 0-1  | èµ·å§‹æ ‡è¯† | 0xAA55 |
| 2-3  | å¾ªç¯è®¡æ•°å™¨ | 16ä½è®¡æ•°å€¼ |
| 4-7  | æ—¶é—´æˆ³ | 32ä½æ—¶é—´æˆ³ |

### æµ‹è¯•æ—¥å¿—è¾“å‡º

#### æˆåŠŸå¾ªç¯ç¤ºä¾‹
```
[LOOP #1] STM32 CAN1 -> Message sent to MCP2515 (Time: 5000 ms)
[RELAY] MCP2515 received message from STM32 CAN1 (Time: 5001 ms)
[DATA] MCP2515 received: AA 55 00 01 00 00 13 88
[RELAY] MCP2515 -> Message relayed to STM32 CAN1
[LOOP #1] STM32 CAN1 <- Message received from MCP2515 (Loop time: 15 ms)
[SUCCESS] Loop #1 completed successfully
[DATA] Received: AA 55 00 01 00 00 13 88
```

#### ç»Ÿè®¡ä¿¡æ¯ç¤ºä¾‹
```
=== CAN Loop Test Statistics ===
Total Loops: 10
Successful Loops: 9
Failed Loops: 1
Timeout Count: 1
Success Rate: 90.0%
Current Time: 15000 ms
===============================
```

### ç¼–è¯‘æ­¥éª¤

#### å¿«é€Ÿç¼–è¯‘ï¼ˆæ¨èï¼‰
```bash
# åŒå‡»è¿è¡Œç¼–è¯‘è„šæœ¬
build_project.bat
```

#### æ‰‹åŠ¨ç¼–è¯‘
1. æ‰“å¼€STM32CubeIDE
2. å¯¼å…¥é¡¹ç›®å·¥ç¨‹
3. æ£€æŸ¥ç¡¬ä»¶é…ç½®
4. ç¼–è¯‘é¡¹ç›®
5. ä¸‹è½½åˆ°å¼€å‘æ¿

### è°ƒè¯•é…ç½®

#### ä¸²å£è®¾ç½®
- æ³¢ç‰¹ç‡: 115200
- æ•°æ®ä½: 8
- åœæ­¢ä½: 1
- æ ¡éªŒä½: æ— 
- æµæ§: æ— 

#### è°ƒè¯•è¾“å‡ºç¤ºä¾‹
```
=== CAN Communication System Starting ===
Initializing CAN application...
MCP2515 initialization successful
CAN application initialized successfully
Starting CAN dual node communication...
CAN dual node communication initialized

=== System Ready ===
Heartbeat: System running, TX count: 1
Sent Message: ID=0x100, Standard, Data, DLC=6, Data=AA 55 00 00 00 01
Received Message: ID=0x200, Standard, Data, DLC=4, Data=12 34 00 01
Test data received, count: 1
```

## åŠŸèƒ½æµ‹è¯•

### 1. ç³»ç»Ÿå¯åŠ¨æµ‹è¯•
è§‚å¯Ÿä¸²å£è¾“å‡ºï¼Œç¡®è®¤ä»¥ä¸‹ä¿¡æ¯ï¼š
- CANåº”ç”¨åˆå§‹åŒ–æˆåŠŸ
- MCP2515ç¡¬ä»¶æ£€æµ‹é€šè¿‡
- åŒèŠ‚ç‚¹é€šä¿¡å¯åŠ¨æˆåŠŸ

### 2. å¿ƒè·³æ¶ˆæ¯æµ‹è¯•
æ¯ç§’åº”è¯¥çœ‹åˆ°å¿ƒè·³æ¶ˆæ¯å‘é€ï¼š
```
Heartbeat: System running, TX count: X
Sent Message: ID=0x100, Standard, Data, DLC=6, Data=AA 55 XX XX XX XX
```

### 3. å›ç¯æµ‹è¯•
åœ¨MCP2515å›ç¯æ¨¡å¼ä¸‹ï¼Œå‘é€çš„æ¶ˆæ¯åº”è¯¥èƒ½å¤Ÿæ¥æ”¶åˆ°ï¼š
```
Loopback test message sent successfully
Loopback test successful!
```

### 4. åŒèŠ‚ç‚¹é€šä¿¡æµ‹è¯•
è¿æ¥ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œè§‚å¯Ÿæ¶ˆæ¯äº¤äº’ï¼š
```
Sent Message: ID=0x601, Standard, Data, DLC=2, Data=01 02
Received Message: ID=0x602, Standard, Data, DLC=8, Data=...
```

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. MCP2515åˆå§‹åŒ–å¤±è´¥
**ç°è±¡**: "MCP2515 initialization failed"
**åŸå› **: 
- SPIè¿æ¥é—®é¢˜
- ç”µæºä¾›ç”µä¸è¶³
- æ™¶æŒ¯é¢‘ç‡ä¸åŒ¹é…
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥SPIè¿çº¿
- ç¡®è®¤3.3Vä¾›ç”µç¨³å®š
- éªŒè¯8MHzæ™¶æŒ¯

### 2. CANæ¶ˆæ¯å‘é€å¤±è´¥
**ç°è±¡**: "Message send failed"
**åŸå› **:
- CANæ€»çº¿æœªè¿æ¥
- æ³¢ç‰¹ç‡ä¸åŒ¹é…
- æ€»çº¿è´Ÿè½½è¿‡é«˜
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥CAN_Hå’ŒCAN_Lè¿æ¥
- ç¡®è®¤æ³¢ç‰¹ç‡è®¾ç½®
- æ·»åŠ ç»ˆç«¯ç”µé˜»(120Î©)

### 3. ä¸²å£æ— è¾“å‡º
**ç°è±¡**: ä¸²å£è°ƒè¯•åŠ©æ‰‹æ— æ•°æ®
**åŸå› **:
- ä¸²å£è¿çº¿é”™è¯¯
- æ³¢ç‰¹ç‡è®¾ç½®é”™è¯¯
- printfé‡å®šå‘å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥TX/RXè¿çº¿
- ç¡®è®¤115200æ³¢ç‰¹ç‡
- æ£€æŸ¥_writeå‡½æ•°å®ç°

### 4. ä»»åŠ¡è°ƒåº¦å¼‚å¸¸
**ç°è±¡**: ç³»ç»Ÿå¡æ­»æˆ–é‡å¯
**åŸå› **:
- å †æ ˆæº¢å‡º
- ä¼˜å…ˆçº§é…ç½®é”™è¯¯
- ä¸­æ–­å¤„ç†æ—¶é—´è¿‡é•¿
**è§£å†³æ–¹æ¡ˆ**:
- å¢åŠ ä»»åŠ¡å †æ ˆå¤§å°
- è°ƒæ•´ä»»åŠ¡ä¼˜å…ˆçº§
- ä¼˜åŒ–ä¸­æ–­å¤„ç†å‡½æ•°

## æ‰©å±•å¼€å‘

### æ·»åŠ è‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹
1. åœ¨`can_app.h`ä¸­å®šä¹‰æ–°çš„æ¶ˆæ¯ID
2. åœ¨`CAN_ProcessReceivedMessage_App`ä¸­æ·»åŠ å¤„ç†é€»è¾‘
3. åˆ›å»ºå¯¹åº”çš„å‘é€å‡½æ•°
4. æ›´æ–°æ¶ˆæ¯åè®®æ–‡æ¡£

### å¢åŠ æ–°çš„CANèŠ‚ç‚¹
1. ä¿®æ”¹è¿‡æ»¤å™¨é…ç½®
2. æ‰©å±•æ¶ˆæ¯å¤„ç†å‡½æ•°
3. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ç»“æ„
4. æ·»åŠ èŠ‚ç‚¹çŠ¶æ€ç›‘æ§

### ä¼˜åŒ–æ€§èƒ½
1. ä½¿ç”¨DMAè¿›è¡ŒSPIä¼ è¾“
2. å®ç°ä¸­æ–­é©±åŠ¨çš„æ¶ˆæ¯æ¥æ”¶
3. ä¼˜åŒ–æ¶ˆæ¯é˜Ÿåˆ—å¤§å°
4. æ·»åŠ æ¶ˆæ¯ä¼˜å…ˆçº§å¤„ç†

## æŠ€æœ¯æ”¯æŒ

### å‚è€ƒæ–‡æ¡£
- [STM32F407_MCP2515_CANé€šä¿¡ç³»ç»Ÿè½¯ä»¶è¯´æ˜ä¹¦.md](STM32F407_MCP2515_CANé€šä¿¡ç³»ç»Ÿè½¯ä»¶è¯´æ˜ä¹¦.md)
- [STM32F407_MCP2515_CANé€šä¿¡ç³»ç»Ÿæµ‹è¯•æŒ‡å—.md](STM32F407_MCP2515_CANé€šä¿¡ç³»ç»Ÿæµ‹è¯•æŒ‡å—.md)
- STM32F4xxå‚è€ƒæ‰‹å†Œ
- MCP2515æ•°æ®æ‰‹å†Œ
- FreeRTOSç”¨æˆ·æ‰‹å†Œ

### ç‰ˆæœ¬ä¿¡æ¯
- ç‰ˆæœ¬: V1.0
- æ—¥æœŸ: 2024-12-19
- ä½œè€…: æ­£ç‚¹åŸå­æŠ€æœ¯ä¸“å®¶
- è®¸å¯: MIT License

### æ›´æ–°æ—¥å¿—
- V1.0 (2024-12-19): åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
  - å®ŒæˆMCP2515é©±åŠ¨å¼€å‘
  - å®ç°CANåº”ç”¨å±‚å°è£…
  - æ·»åŠ åŒèŠ‚ç‚¹é€šä¿¡åŠŸèƒ½
  - é›†æˆFreeRTOSå¤šä»»åŠ¡ç³»ç»Ÿ
  - å®Œå–„è°ƒè¯•å’Œæµ‹è¯•åŠŸèƒ½

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œåœ¨å®é™…äº§å“ä¸­ä½¿ç”¨å‰è¯·è¿›è¡Œå……åˆ†çš„æµ‹è¯•å’ŒéªŒè¯ã€‚
