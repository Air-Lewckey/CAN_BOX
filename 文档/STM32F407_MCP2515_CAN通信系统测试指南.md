# STM32F407 + MCP2515 CAN通信系统测试指南

## 🎯 测试目标

本指南将帮助您完成STM32F407与MCP2515 CAN控制器通信系统的完整测试，验证系统的各项功能是否正常工作。

## 📋 测试前准备清单

### 硬件准备
- [ ] STM32F407ZGT6开发板
- [ ] MCP2515 CAN控制器模块
- [ ] ST-Link调试器或板载ST-Link
- [ ] USB转串口模块（用于调试输出）
- [ ] 杜邦线若干
- [ ] 面包板（可选）
- [ ] 万用表（用于检查连接）
- [ ] CAN总线终端电阻120Ω（如果测试多节点通信）

### 软件准备
- [ ] STM32CubeIDE（已安装）
- [ ] 串口调试助手（如SSCOM、PuTTY等）
- [ ] CAN总线分析工具（可选，如CANoe、PCAN-View等）

## 🔌 硬件连接检查

### 1. STM32F407与MCP2515连接

**必须严格按照以下连接图进行连接：**

```
STM32F407ZGT6    <-->    MCP2515模块
-----------------------------------------
PB3 (SPI1_SCK)   <-->    SCK (时钟)
PB4 (SPI1_MISO)  <-->    SO  (主入从出)
PB5 (SPI1_MOSI)  <-->    SI  (主出从入)
PB12 (GPIO_OUT)  <-->    CS  (片选)
PB10 (EXTI_IN)   <-->    INT (中断)
3.3V             <-->    VCC (电源正)
GND              <-->    GND (电源负)
```

### 2. 串口连接（用于调试输出）

```
STM32F407ZGT6    <-->    USB转串口
---------------------------------
PA2 (USART2_TX)  <-->    RX
PA3 (USART2_RX)  <-->    TX
GND              <-->    GND
```

**注意：** 我们使用USART2而不是USART1，因为PA9/PA10可能在某些开发板上被占用或未引出。

### 3. 连接检查步骤

1. **断电检查**：在断电状态下用万用表检查连接
2. **短路检查**：确保VCC和GND之间无短路
3. **信号线检查**：确保SPI信号线连接正确
4. **电源检查**：上电后用万用表测量MCP2515的VCC引脚是否为3.3V

## 💻 程序下载和调试

### 1. 下载程序到STM32

**步骤1：连接调试器**
- 将ST-Link连接到STM32F407开发板
- 确保ST-Link驱动已正确安装

**步骤2：下载程序**
1. 在STM32CubeIDE中打开CAN_BOX工程
2. 点击 `Run` → `Debug` (F11) 或点击调试按钮
3. 选择调试配置，点击 `Debug`
4. 等待程序下载完成

**步骤3：运行程序**
- 程序下载后会自动停在main函数入口
- 点击 `Resume` (F8) 让程序开始运行

### 2. 串口调试设置

**串口参数设置：**
- 波特率：115200
- 数据位：8
- 停止位：1
- 奇偶校验：无
- 流控制：无

**连接步骤：**
1. 打开串口调试助手
2. 选择正确的COM端口
3. 设置波特率为115200
4. 打开串口连接

## 🧪 功能测试步骤

### 第一阶段：基础功能测试

#### 1. 系统启动测试

**预期串口输出：**
```
=== STM32F407 + MCP2515 CAN通信系统启动 ===
系统时钟: 168 MHz
SPI1时钟: 2 MHz
CAN应用初始化成功!
CAN自检测试通过!
系统初始化完成，开始运行...

默认任务启动
CAN发送任务启动
CAN接收任务启动
```

**测试结果判断：**
- ✅ **成功**：看到完整的启动信息
- ❌ **失败**：没有输出或输出不完整

**失败排查：**
1. 检查串口连接和参数设置
2. 检查程序是否正确下载
3. 检查电源供电是否正常

#### 2. MCP2515硬件检测

**测试方法：**
观察启动信息中的"CAN自检测试"结果

**预期结果：**
```
CAN自检测试通过!
```

**失败排查：**
1. 检查SPI连接是否正确
2. 检查MCP2515电源是否正常
3. 检查片选信号CS是否连接正确

#### 3. 心跳消息发送测试

**预期串口输出：**
```
[CAN_SEND] 发送心跳消息: ID=0x100, 计数器=1
[CAN_SEND] 发送心跳消息: ID=0x100, 计数器=2
[CAN_SEND] 发送心跳消息: ID=0x100, 计数器=3
...
```

**测试结果判断：**
- ✅ **成功**：每秒看到一次心跳消息发送
- ❌ **失败**：没有心跳消息或发送失败

### 第二阶段：通信功能测试

#### 1. 单节点回环测试

**测试目的：**
验证MCP2515的发送和接收功能

**测试方法：**
1. 系统启动时会自动执行回环测试
2. 观察串口输出的测试结果

**预期结果：**
```
开始CAN应用自检测试...
MCP2515硬件测试通过
回环模式设置成功
回环测试消息发送成功
回环测试成功!
CAN应用自检测试完成!
```

#### 2. 双节点通信测试（可选）

**硬件准备：**
- 准备两套相同的硬件
- 用CAN_H和CAN_L连接两个MCP2515模块
- 在总线两端各加一个120Ω终端电阻

**连接图：**
```
MCP2515_1    <-->    CAN总线    <-->    MCP2515_2
CANH         <-->    CANH       <-->    CANH
CANL         <-->    CANL       <-->    CANL
120Ω终端电阻                           120Ω终端电阻
```

**测试方法：**
1. 两个节点同时上电
2. 观察串口输出，应该能看到互相接收到的消息

**预期结果：**
```
节点1发送: [CAN_SEND] 发送心跳消息: ID=0x100
节点2接收: [CAN_RECV] 接收到消息: ID=0x100, 数据=AA 55 00 00 00 01 12 34
```

### 第三阶段：高级功能测试

#### 1. 消息过滤测试

**测试方法：**
1. 修改代码设置消息过滤器
2. 发送不同ID的消息
3. 验证只接收指定ID的消息

**代码修改示例：**
```c
// 在CAN_App_Init()中添加
CAN_App_SetFilter(0x100, 0x700, 0);  // 只接收0x100-0x1FF的消息
```

#### 2. 错误处理测试

**测试方法：**
1. 故意断开CAN总线连接
2. 观察系统的错误处理机制
3. 重新连接后验证恢复功能

**预期行为：**
- 系统应该检测到错误并报告
- 重新连接后应该自动恢复通信

## 📊 性能测试

### 1. 吞吐量测试

**测试方法：**
1. 修改发送间隔为最小值
2. 统计单位时间内的消息发送数量
3. 计算实际吞吐量

**理论值：**
- 500kbps波特率下，理论最大约为每秒500条标准帧消息

### 2. 延迟测试

**测试方法：**
1. 在发送和接收处添加时间戳
2. 计算消息从发送到接收的延迟时间

**预期延迟：**
- 正常情况下应该小于1ms

## 🔧 调试技巧

### 1. 串口调试输出

**添加调试信息：**
```c
// 在关键位置添加调试输出
printf("[DEBUG] 当前状态: %d\r\n", current_status);
printf("[DEBUG] 错误代码: 0x%02X\r\n", error_code);
```

### 2. LED指示灯调试

**添加LED指示：**
```c
// 发送成功时点亮LED
HAL_GPIO_WritePin(LED_GPIO_Port, LED_Pin, GPIO_PIN_SET);

// 发送失败时熄灭LED
HAL_GPIO_WritePin(LED_GPIO_Port, LED_Pin, GPIO_PIN_RESET);
```

### 3. 逻辑分析仪调试

**监控信号：**
- SPI时钟信号（SCK）
- SPI数据信号（MOSI/MISO）
- 片选信号（CS）
- 中断信号（INT）

## 🚨 常见问题排查

### 问题1：系统无法启动

**现象：**
- 串口无输出
- 程序似乎没有运行

**排查步骤：**
1. 检查电源供电是否正常
2. 检查程序是否正确下载
3. 检查时钟配置是否正确
4. 检查串口连接和参数设置

### 问题2：MCP2515初始化失败

**现象：**
```
CAN应用初始化失败!
```

**排查步骤：**
1. 检查SPI连接是否正确
2. 检查MCP2515电源是否为3.3V
3. 检查片选信号CS是否正确连接
4. 用万用表测量SPI信号是否有波形

### 问题3：消息发送失败

**现象：**
```
[CAN_SEND] 消息发送失败
```

**排查步骤：**
1. 检查CAN总线连接
2. 检查终端电阻是否正确
3. 检查波特率设置是否匹配
4. 检查MCP2515工作模式

### 问题4：消息接收失败

**现象：**
- 发送正常但接收不到消息

**排查步骤：**
1. 检查中断连接是否正确
2. 检查中断配置是否正确
3. 检查消息过滤器设置
4. 检查接收缓冲区是否满

### 问题5：系统运行不稳定

**现象：**
- 偶尔死机或重启
- 消息丢失

**排查步骤：**
1. 检查任务栈大小是否足够
2. 检查中断优先级设置
3. 检查内存使用情况
4. 检查电源稳定性

## 📈 测试结果记录

### 基础功能测试记录表

| 测试项目 | 预期结果 | 实际结果 | 状态 | 备注 |
|----------|----------|----------|------|------|
| 系统启动 | 正常启动信息 |  | ⭕ |  |
| MCP2515检测 | 硬件检测通过 |  | ⭕ |  |
| 心跳发送 | 每秒发送一次 |  | ⭕ |  |
| 回环测试 | 测试通过 |  | ⭕ |  |
| 双节点通信 | 互相收发消息 |  | ⭕ |  |

**状态说明：**
- ✅ 通过
- ❌ 失败
- ⭕ 待测试

### 性能测试记录表

| 性能指标 | 理论值 | 实测值 | 达标情况 |
|----------|--------|--------|---------|
| 最大发送速率 | ~500 msg/s |  | ⭕ |
| 消息延迟 | <1ms |  | ⭕ |
| CPU使用率 | <10% |  | ⭕ |
| 内存使用 | <12KB |  | ⭕ |

## 🎯 测试完成标准

### 基本功能要求（必须全部通过）
- [ ] 系统正常启动
- [ ] MCP2515硬件检测通过
- [ ] 心跳消息正常发送
- [ ] 回环测试通过
- [ ] 串口调试输出正常

### 通信功能要求（至少通过80%）
- [ ] 单节点自发自收正常
- [ ] 双节点互相通信正常
- [ ] 消息过滤功能正常
- [ ] 错误检测和恢复正常
- [ ] 中断响应正常

### 性能要求（参考标准）
- [ ] 发送速率 > 100 msg/s
- [ ] 消息延迟 < 5ms
- [ ] 系统稳定运行 > 1小时
- [ ] 错误率 < 1%

## 🚀 下一步开发建议

### 功能扩展方向
1. **添加更多消息类型**：传感器数据、控制命令等
2. **实现应用层协议**：定义完整的通信协议栈
3. **添加数据记录功能**：消息日志和统计分析
4. **开发PC端工具**：监控和配置软件

### 性能优化方向
1. **优化中断处理**：减少中断延迟
2. **优化内存使用**：减少RAM占用
3. **优化功耗**：添加低功耗模式
4. **优化可靠性**：增强错误处理机制

### 产品化建议
1. **完善文档**：用户手册和技术文档
2. **添加测试用例**：自动化测试脚本
3. **进行认证测试**：EMC和可靠性测试
4. **建立质量体系**：代码审查和版本管理

---

**测试指南版本**: v1.0.0  
**最后更新**: 2025年1月27日  
**适用工程**: STM32F407 + MCP2515 CAN通信系统  
**作者**: STM32专家团队  

> 🎉 **祝贺！** 完成所有测试后，您就拥有了一个完整可用的CAN通信系统！如有问题，请参考故障排查部分或联系技术支持。