# 屏幕UART通讯协议文档

## 一、协议概述

本协议定义了CAN测试盒与显示屏幕之间通过UART接口进行数据交换的通讯规范。系统采用简化的单字节指令协议，使用单个字节的HEX指令直接控制PEPS相关的CAN报文发送，无需复杂的帧格式。


## 二、硬件连接

### 2.1 UART接口配置
- **接口**: UART2
- **波特率**: 115200 bps
- **数据位**: 8位
- **停止位**: 1位
- **奇偶校验**: 无
- **流控**: 无

### 2.2 引脚连接
- **TX (PA2)**: 发送数据 (芯片 -> 屏幕)
- **RX (PA3)**: 接收数据 (屏幕 -> 芯片)
- **GND**: 公共地

### 2.3 通讯方向
- **屏幕 -> 芯片**: 发送控制命令，控制CAN报文的发送
- **芯片 -> 屏幕**: 反馈执行状态，上报CAN接收数据

## 三、简化单字节指令协议

### 3.1 单字节指令与CAN报文矩阵对照表

#### 3.1.1 PEPS控制指令映射表

| 指令码 | 功能描述 | 对应PEPS命令 | CAN ID | 数据内容 | 发送方式 | 周期 |
|--------|----------|--------------|--------|----------|----------|------|
| **0xA1** | 开启SCW1唤醒 | SCW1_WAKEUP_START | 0x05B | [0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 200ms |
| **0xB1** | 关闭SCW1唤醒 | SCW1_WAKEUP_STOP | 0x05B | - | 停止发送 | - |
| **0xA2** | 开启SCW2唤醒 | SCW2_WAKEUP_START | 0x401 | [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 500ms |
| **0xB2** | 关闭SCW2唤醒 | SCW2_WAKEUP_STOP | 0x401 | - | 停止发送 | - |
| **0xA3** | 开启钥匙位置 | KEY_POS_START | 0x442 | [0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 100ms |
| **0xB3** | 关闭钥匙位置 | KEY_POS_STOP | 0x442 | - | 停止发送 | - |
| **0xA4** | 开启BSI状态 | BSI_STATUS_START | 0x036 | [0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 100ms |
| **0xB4** | 关闭BSI状态 | BSI_STATUS_STOP | 0x036 | - | 停止发送 | - |

#### 3.1.2 数据变体指令映射表

| 指令码 | 功能描述 | 对应PEPS命令 | CAN ID | 数据内容 | 发送方式 | 周期 |
|--------|----------|--------------|--------|----------|----------|------|
| **0xC1** | SCW1唤醒(REV=0) | SCW1_WAKEUP_RESET | 0x05B | [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 200ms |
| **0xC2** | SCW2唤醒(激活) | SCW2_WAKEUP_ACTIVE | 0x401 | [0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 500ms |
| **0xC3** | 钥匙不在位 | KEY_POS_ABSENT | 0x442 | [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 100ms |
| **0xC4** | BSI异常状态 | BSI_STATUS_ERROR | 0x036 | [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 100ms |
| **0xD1** | SCW1唤醒(自定义1) | SCW1_WAKEUP_CUSTOM1 | 0x05B | [0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 200ms |
| **0xD2** | SCW2唤醒(自定义1) | SCW2_WAKEUP_CUSTOM1 | 0x401 | [0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 500ms |
| **0xD3** | 钥匙插入中 | KEY_POS_INSERTING | 0x442 | [0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 100ms |
| **0xD4** | BSI待机状态 | BSI_STATUS_STANDBY | 0x036 | [0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 100ms |
| **0xE1** | SCW1唤醒(自定义2) | SCW1_WAKEUP_CUSTOM2 | 0x05B | [0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 200ms |
| **0xE2** | SCW2唤醒(自定义2) | SCW2_WAKEUP_CUSTOM2 | 0x401 | [0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 500ms |
| **0xE3** | 钥匙拔出中 | KEY_POS_REMOVING | 0x442 | [0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 100ms |
| **0xE4** | BSI初始化状态 | BSI_STATUS_INIT | 0x036 | [0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] | 周期发送 | 100ms |

#### 3.1.3 多字节数据变体指令

| 指令码 | 功能描述 | 对应PEPS命令 | CAN ID | 数据内容 | 发送方式 | 周期 |
|--------|----------|--------------|--------|----------|----------|------|
| **0xF1** | SCW1完整测试数据 | SCW1_FULL_TEST | 0x05B | [0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08] | 周期发送 | 200ms |
| **0xF2** | SCW2完整测试数据 | SCW2_FULL_TEST | 0x401 | [0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77, 0x88] | 周期发送 | 500ms |
| **0xF3** | 钥匙位置完整数据 | KEY_POS_FULL_TEST | 0x442 | [0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0xFF, 0x00, 0x11] | 周期发送 | 100ms |
| **0xF4** | BSI完整测试数据 | BSI_FULL_TEST | 0x036 | [0xFF, 0xEE, 0xDD, 0xCC, 0xBB, 0xAA, 0x99, 0x88] | 周期发送 | 100ms |

#### 3.1.4 系统控制指令

| 指令码 | 功能描述 | 执行动作 |
|--------|----------|----------|
| **0xFF** | 停止所有周期报文 | 调用PEPS_StateMachine_StopAllPeriodicMessages() |
| **0x00** | 系统复位 | 调用NVIC_SystemReset() |

### 3.2 CAN报文详细信息

#### 3.2.1 SCW1 PEPS唤醒报文 (0x05B)
- **功能**: PEPS系统唤醒信号
- **数据说明**: Byte0.Bit0 = PEPS_WAKEUP信号
- **默认值**: 0x01表示唤醒激活
- **发送周期**: 200ms

#### 3.2.2 SCW2 PEPS唤醒报文 (0x401)
- **功能**: 第二路PEPS唤醒信号
- **数据说明**: 全0信号占位
- **默认值**: 0x00表示待机状态
- **发送周期**: 500ms

#### 3.2.3 钥匙位置报文 (0x442)
- **功能**: 钥匙位置状态报告
- **数据说明**: Byte0.Bit0-1 = 钥匙位置状态
- **默认值**: 0x01表示钥匙在位
- **发送周期**: 100ms

#### 3.2.4 BSI状态报文 (0x036)
- **功能**: BSI（车身系统接口）状态
- **数据说明**: Byte0.Bit0 = PHASE_VIE信号
- **默认值**: 0x01表示BSI激活
- **发送周期**: 100ms

#### 3.2.5 数据变体指令详细说明

##### 3.2.5.1 SCW1唤醒信号变体
- **0xA1**: REV_PEPS=1（标准唤醒激活）
- **0xC1**: REV_PEPS=0（唤醒信号复位）
- **0xD1**: REV_PEPS=2（自定义唤醒状态1）
- **0xE1**: REV_PEPS=3（自定义唤醒状态2）
- **0xF1**: 完整8字节测试数据（用于协议完整性测试）

##### 3.2.5.2 SCW2唤醒信号变体
- **0xA2**: 全0信号占位（标准NM唤醒同步）
- **0xC2**: REV_PEPS=1（激活状态）
- **0xD2**: REV_PEPS=2（自定义状态1）
- **0xE2**: REV_PEPS=3（自定义状态2）
- **0xF2**: 完整8字节测试数据（用于协议完整性测试）

##### 3.2.5.3 钥匙位置状态变体
- **0xA3**: KEY_POS=1（钥匙在位）
- **0xC3**: KEY_POS=0（钥匙不在位）
- **0xD3**: KEY_POS=2（钥匙插入中）
- **0xE3**: KEY_POS=3（钥匙拔出中）
- **0xF3**: 完整8字节测试数据（用于协议完整性测试）

##### 3.2.5.4 BSI状态变体
- **0xA4**: PHASE_VIE=1（BSI正常激活）
- **0xC4**: PHASE_VIE=0（BSI异常状态）
- **0xD4**: PHASE_VIE=2（BSI待机状态）
- **0xE4**: PHASE_VIE=3（BSI初始化状态）
- **0xF4**: 完整8字节测试数据（用于协议完整性测试）


## 指令分类说明

### 6.1 指令码分配规则
- **0xA1-0xA4**: 基础开启指令（标准数据）
- **0xB1-0xB4**: 基础关闭指令
- **0xC1-0xC4**: 数据变体指令1（状态复位/异常）
- **0xD1-0xD4**: 数据变体指令2（自定义状态1）
- **0xE1-0xE4**: 数据变体指令3（自定义状态2）
- **0xF1-0xF4**: 完整性测试指令（8字节完整数据）
- **0xFF**: 停止所有周期报文
- **0x00**: 系统复位

---

**文档版本**: V2.0  
**更新日期**: 2025-09-01
**适用系统**: STM32F407+X5屏幕 CAN测试盒