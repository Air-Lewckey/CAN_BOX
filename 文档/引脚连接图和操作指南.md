# STM32F407 引脚连接图和操作指南（片上 CAN1 + 可选 MCP2515）

本文对当前工程的硬件连接与上电操作进行统一说明。工程默认使用片上 CAN1 搭配车规 CAN 收发器（如 SN65HVD230），MCP2515 外置控制器为可选方案（SPI1 已保留但默认不启用）。

——

## 1. 硬件总览（与工程现状一致）

- MCU：STM32F407ZG
- 片上 CAN1：工作通道（500 kbps，Normal 模式）
- 可选 CAN2：保留（未启用）
- CAN 收发器：SN65HVD230 或同类（TXD/RXD/CANH/CANL/RS）
- 串口：USART2（115200，用于日志/控制）
- SPI1：保留用于 MCP2515（当前硬件默认不装，代码未启用）

——

## 2. 片上 CAN1 引脚与收发器连接

MCU 与 CAN1 引脚（GPIO 复用为 AF9）：
- PA11 → CAN1_RX（输入）
- PA12 → CAN1_TX（输出）

MCU 与收发器（以 SN65HVD230 为例）的连接：
- PA12 (CAN1_TX) → 收发器 TXD
- PA11 (CAN1_RX) ← 收发器 RXD
- 3.3V → 收发器 VCC（请确认器件供电要求）
- GND ↔ 收发器 GND（与 MCU 共地）
- CANH/CANL ↔ 车辆/测试 CAN 总线（双绞线）
- RS/Standby（斜率控制/待机）
  - 常用做法：RS 接地（慢速斜率，低 EMI），保持常开
  - 如需待机控制：RS 引出到一个 GPIO（如 PBx），高电平进入待机，低电平正常工作（具体以所用收发器数据手册为准）

总线端接与供电注意事项：
- 在总线两端各放置 120 Ω 终端电阻（单板直连测试时保证一端 120 Ω），必要时加共模电感/TVS 提升抗干扰
- 确保所有设备共地且供电稳定，避免热插拔导致的错误帧

——

## 3. 可选 CAN2 引脚（默认未启用）

- PB12 → CAN2_RX（AF9）
- PB13 → CAN2_TX（AF9）

说明：工程保留了 CAN2 的初始化与中断入口，但 main.c 未调用 MX_CAN2_Init，默认不启用。若将来需要作为监听节点或双路冗余，可按 CAN1 的连接方式加装第二收发器并在代码中启用。

——

## 4. 串口（USART2）连接与用途

- PA2 → USART2_TX → 连接到 USB‑串口工具 RX（或上位机）
- PA3 ← USART2_RX ← 连接到 USB‑串口工具 TX（或上位机）
- 波特率：115200，8N1，无流控

用途：
- 工程内 printf 日志经 `_write/__io_putchar` 重定向到 USART2 输出，便于观察 CAN [TX]/[RX]/[ERR] 等运行信息
- 可通过 PEPS 辅助模块的串口控制字节开启/关闭指定的周期 CAN 报文（详见《工程代码解析.md》和《PEPS_API_使用指南.md》）

——

## 5. 可选 MCP2515 外置控制器连接（SPI1）

当前工程默认不启用 MCP2515，SPI1 仅保留。如需改用 MCP2515，请参考以下连接并在代码中启用相应驱动：

SPI1 引脚（AF5）：
- PB3 → SPI1_SCK
- PB4 ← SPI1_MISO
- PB5 → SPI1_MOSI

片选与中断（需选定并配置为普通 GPIO）：
- CS（片选）：选择一个 GPIO（例如 PA4/PB6 等）连接 MCP2515 的 CS，引脚在代码中作为软件 NSS 控制
- INT（中断）：选择一个 GPIO（例如 PA0/PB0 等）连接 MCP2515 的 INT，并在 EXTI 中断里调用 MCP2515 读帧处理

供电与总线：
- 3.3V/GND 按器件要求供电（确认是否需要 5V）
- MCP2515 仍需一个外置 CAN 收发器（如 TJA1050/SN65HVD230）连接到 CANH/CANL，总线端接与共地同第 2 节

代码启用指引：
- 在 main.c 中初始化 SPI1，并创建 MCP2515 对应的任务/回调（参考《STM32F407_MCP2515_CAN工程创建详细步骤.md》与《MCP2515_简单测试代码.c》）
- 注意：当前工程“SPI1（MCP2515）硬件默认不装”，若硬件板未焊接，请勿在软件中启用，否则将导致初始化失败

——

## 6. 上电操作指南（片上 CAN1 模式）

1) 连接硬件
- 将 PA11/PA12 与收发器 RXD/TXD 正确连接；收发器接入 CANH/CANL 与总线；确保终端电阻与共地
- 连接 USART2 到 PC（USB‑串口），打开串口终端（115200）

2) 上电与启动
- 上电后，工程会初始化 CAN1 与过滤器（PEPS 过滤器），并启动 FreeRTOS
- 打开串口终端可看到 [TX]/[RX]/[ERR] 日志输出

3) 功能验证
- 使用 PEPS 辅助模块：通过串口发送控制字节开启/关闭指定周期报文（详见《PEPS_API_使用指南.md》）
- 使用 CANoe/VN1640 或其他分析仪：监视总线帧并与日志对照（详见《CANOE_VN1640_CAN通信验证指南.md》）

4) 常见问题
- 无接收：检查过滤器是否仅放行 PEPS 相关 ID，如需通用接收，请暂时放宽过滤器或清空过滤器配置
- 错误多：检查总线端接、供电与共地，确认波特率一致（500 kbps）
- 串口无日志：检查 USART2 连接与波特率，确认 `_write/__io_putchar` 未被修改

——

## 7. 参考与交叉文档
- 《工程代码解析.md》：入口、任务、回调调用链与接口说明
- 《STM32F407_CAN1外设配置指南.md》：片上 CAN 的寄存器/位时序参数
- 《PEPS_API_使用指南.md》：串口控制字节与周期报文映射
- 《STM32F407_MCP2515_CAN工程创建详细步骤.md》：启用 MCP2515 的完整流程
- 《CANOE_VN1640_CAN通信验证指南.md》：与 CAN 分析仪的联调方法

如需我根据你的实际硬件版本（是否焊接 MCP2515、所用收发器型号）进一步定制连接图与最小示例代码，请告知具体器件与目标模式，我可同步更新文档与工程代码。